<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - 3DPrint Opti</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-sm mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-blue-600">User Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userDisplay" class="text-gray-600"></span>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        <!-- Balance Card -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg shadow-lg p-6 mb-8 text-white">
            <h3 class="text-lg font-semibold opacity-90">Available Balance</h3>
            <div class="flex items-baseline mt-2">
                <span class="text-4xl font-bold" id="balanceDisplay">--</span>
                <span class="ml-2 text-xl opacity-80">CNY</span>
            </div>
            <p class="text-sm mt-2 opacity-75">Used for optimization service fees.</p>
        </div>

        <!-- Optimization Service -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Start Optimization</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">STL File URL</label>
                    <input type="text" id="stlUrl" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3" placeholder="https://example.com/my-gear.stl" value="https://example.com/gear_v1.stl">
                    <p class="text-xs text-gray-500 mt-1">For MVP, provide a public URL to your STL file.</p>
                </div>

                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <h4 class="font-medium text-gray-700 mb-2">Estimated Cost</h4>
                    <p class="text-sm text-gray-600">Based on standard gear volume: <span class="font-bold text-gray-900">~45.00 CNY</span></p>
                </div>

                <button onclick="runOptimize()" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 transition font-medium">
                    Analyze & Optimize Now
                </button>
            </div>

            <!-- Result Area -->
            <div id="resultArea" class="hidden mt-6 p-4 rounded-lg">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('currentUser');
        if(!userId) window.location.href = '/index.html';
        
        document.getElementById('userDisplay').textContent = `User: ${userId}`;

        async function fetchBalance() {
            try {
                const res = await fetch(`/api/users/${userId}/balance`);
                const data = await res.json();
                document.getElementById('balanceDisplay').textContent = data.balance_cny.toFixed(2);
            } catch(e) {
                console.error(e);
            }
        }

        async function runOptimize() {
            const btn = document.querySelector('button');
            const resArea = document.getElementById('resultArea');
            
            btn.disabled = true;
            btn.textContent = 'Processing...';
            resArea.classList.add('hidden');

            try {
                const res = await fetch('/api/service/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        stl_file_url: document.getElementById('stlUrl').value
                    })
                });

                const data = await res.json();
                resArea.classList.remove('hidden');

                if (res.ok) {
                    // Success
                    resArea.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200';
                    resArea.innerHTML = `
                        <h4 class="text-lg font-bold text-green-800 mb-2">Optimization Started!</h4>
                        <div class="text-sm text-green-700 space-y-1">
                            <p>Job ID: <span class="font-mono">${data.job_id}</span></p>
                            <p>Cost: <span class="font-bold">-${data.cost} CNY</span></p>
                            <p>Paid via: ${data.paid_with}</p>
                            <p class="mt-2 border-t border-green-200 pt-2">Remaining Balance: <span class="font-bold">${data.remaining_balance} CNY</span></p>
                        </div>
                    `;
                    fetchBalance(); // Update header
                } else if (res.status === 402) {
                    // Payment Required
                    resArea.className = 'mt-6 p-4 rounded-lg bg-yellow-50 border border-yellow-200';
                    resArea.innerHTML = `
                        <h4 class="text-lg font-bold text-yellow-800 mb-2">⚠️ Insufficient Trial Credits</h4>
                        <p class="text-sm text-yellow-700 mb-4">${data.message}</p>
                        <div class="bg-white p-3 rounded border border-yellow-300">
                            <p class="text-sm text-gray-600">Please pay the difference to continue:</p>
                            <p class="text-xl font-bold text-gray-900 my-2">${data.shortfall} CNY</p>
                            <a href="${data.payment_url}" target="_blank" class="block w-full text-center bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700">
                                Pay Now (Mock Link)
                            </a>
                        </div>
                    `;
                } else {
                    // Other Error
                    resArea.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200';
                    resArea.innerHTML = `<p class="text-red-700">Error: ${data.message}</p>`;
                }

            } catch(e) {
                alert('System error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze & Optimize Now';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/index.html';
        }

        // Init
        fetchBalance();
    </script>
</body>
</html>
